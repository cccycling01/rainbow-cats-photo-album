<!--miniprogram/pages/MessageBoard/index.wxml-->
<view class="message-container">
  <!-- æ ‡é¢˜ -->
  <view class="header">
    <text class="title">ğŸ’¬ æˆ‘ä»¬çš„ç•™è¨€æ¿</text>
    <text class="subtitle">è®°å½•æˆ‘ä»¬çš„ç‚¹ç‚¹æ»´æ»´</text>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="message-list" 
    scroll-y 
    scroll-top="0"
    enhanced
    show-scrollbar="{{false}}"
  >
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{messages.length === 0 && !loading}}">
      <text class="empty-icon">ğŸ’Œ</text>
      <text class="empty-text">è¿˜æ²¡æœ‰ç•™è¨€</text>
      <text class="empty-hint">å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯å§~</text>
    </view>

    <!-- æ¶ˆæ¯ -->
    <view 
      class="message-item {{item.senderId === currentUserId ? 'mine' : 'theirs'}}"
      wx:for="{{messages}}"
      wx:key="_id"
    >
      <!-- æ‚„æ‚„è¯æç¤º -->
      <view class="whisper-hint" wx:if="{{item.type === 'whisper' && item._openid !== currentUserOpenid && !item.isRead}}">
        <text>ğŸ’­ ç‚¹å‡»æŸ¥çœ‹æ‚„æ‚„è¯</text>
      </view>

      <!-- æ¶ˆæ¯æ°”æ³¡ -->
      <view 
        class="message-bubble {{item.type === 'whisper' ? 'whisper' : ''}}"
        bindtap="onWhisperTap"
        data-index="{{index}}"
      >
        <view class="bubble-content">
          <text class="message-text">{{item.content}}</text>
        </view>
        <view class="bubble-meta">
          <text class="sender-name">{{item.sender}}</text>
          <text class="message-time">{{item.timeStr}}</text>
          <text class="whisper-icon" wx:if="{{item.type === 'whisper'}}">ğŸ’­</text>
        </view>
      </view>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-area" style="bottom: {{inputBottom}}px">
    <!-- æ‚„æ‚„è¯å¼€å…³ -->
    <view 
      class="whisper-toggle {{isWhisper ? 'active' : ''}}"
      bindtap="toggleWhisper"
    >
      <text>{{isWhisper ? 'ğŸ’­' : 'ğŸ’¬'}}</text>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-wrapper">
      <input 
        class="message-input"
        type="text"
        placeholder="{{isWhisper ? 'å‘é€æ‚„æ‚„è¯...' : 'è¯´ç‚¹ä»€ä¹ˆ...'}}"
        value="{{newMessage}}"
        bindinput="onMessageInput"
        bindfocus="onInputFocus"
        bindblur="onInputBlur"
        maxlength="500"
        confirm-type="send"
        bindconfirm="sendMessage"
      />
    </view>

    <!-- å‘é€æŒ‰é’® -->
    <view 
      class="send-btn {{newMessage.trim() ? 'active' : ''}}"
      bindtap="sendMessage"
    >
      <text>å‘é€</text>
    </view>
  </view>
</view>
